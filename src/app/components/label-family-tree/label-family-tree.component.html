<div class="label-family-tree">
  <!-- Header with search and controls -->
  <div class="tree-header">
    <div class="search-section">
      <div class="search-header">
        <h1 #pageHeading tabindex="-1">Label Family Trees</h1>
      </div>
      <div class="search-controls">
        <div class="search-input-wrapper">
          <input #searchInput type="text" class="search-input" placeholder="Search for a record label..."
            [formControl]="searchControl" />
      </div>

      <!-- Search Results -->
      @if (shouldShowSearchResults()) {
      <div class="search-results">
        @for (label of searchResults(); track label.id) {
        <div class="search-result-item" (click)="selectLabel(label); $event.stopPropagation()">
          <div class="label-info">
            <h3>{{ label.name }}</h3>
            <div class="label-meta">
              <span class="label-type">{{ label.type }}</span>
              @if (label.country) {
              <span class="label-country">{{ label.country }}</span>
              }
              @if (label.disambiguation) {
              <span class="disambiguation">({{ label.disambiguation }})</span>
              }
            </div>
          </div>
        </div>
        }
      </div>
      }
    </div>

  </div>

  <!-- Spotify Success Message -->
  @if (createdPlaylist()) {
  <div class="spotify-success">
    <div class="success-content">
      <h4>âœ“ Spotify Playlist Created!</h4>
      <p><strong>{{ createdPlaylist()?.name }}</strong></p>
      <a [href]="createdPlaylist()?.external_urls?.spotify" target="_blank" class="open-spotify-link">
        Open in Spotify
      </a>
    </div>
    <button class="close-success" (click)="createdPlaylist.set(null)" type="button">Ã—</button>
  </div>
  }

  <!-- Error Display -->
  @if (error()) {
  <div class="error-message">
    <span class="error-icon">âš </span>
    {{ error() }}
  </div>
  }

  <!-- Main Content Area -->
  <div class="tree-content">
    @if (isLoadingTree()) {
    <div class="loading-tree">
      <div class="loading-spinner"></div>
      <p>Loading family tree...</p>
    </div>
    } @else if (hasTree()) {
    <div class="tree-container">
      <!-- Tree Statistics and Actions -->
      <div class="tree-header-actions">
        <div class="tree-stats">
          <h3>Create Spotify Playlist</h3>
        </div>

        <div class="tree-actions">
          <!-- Spotify Playlist Creation -->
          <div class="spotify-controls">
            <div class="track-count-control">
              <label for="tracks-per-album">Tracks per album:</label>
              <div class="track-input-group">
                <input id="tracks-per-album" type="number" min="1" max="50" [value]="tracksPerAlbum()"
                  [disabled]="useAllTracks()" (input)="updateTracksPerAlbum(+$any($event.target).value)"
                  class="track-count-input" [class.disabled]="useAllTracks()"
                  title="Number of tracks to include from each album (1-50)">
                <button type="button" class="reset-tracks-btn" [disabled]="useAllTracks()"
                  (click)="resetTracksPerAlbum()" title="Reset to default (5 tracks)">
                  â†»
                </button>
              </div>
            </div>

            <div class="all-tracks-control">
              <label class="checkbox-label">
                <input type="checkbox" [checked]="useAllTracks()" (change)="toggleAllTracks()"
                  class="all-tracks-checkbox">
                <span class="checkbox-text">Use all tracks from each album</span>
              </label>
              <p class="track-mode-description">{{ trackModeDescription() }}</p>
            </div>


            <div class="year-filter-control">
              <label class="checkbox-label">
                <input type="checkbox" [checked]="enableYearFilter()" (change)="toggleYearFilter()"
                  class="year-filter-checkbox">
                <span class="checkbox-text">Filter by release year</span>
              </label>

              @if (enableYearFilter()) {
              <div class="year-range-inputs">
                <div class="year-input-group">
                  <label for="start-year">From:</label>
                  <input id="start-year" type="number" min="1900" [max]="getCurrentYear() + 10" placeholder="e.g. 1980"
                    [value]="startYear() || ''"
                    (input)="updateStartYear($any($event.target).value ? +$any($event.target).value : null)"
                    class="year-input">
                </div>
                <div class="year-input-group">
                  <label for="end-year">To:</label>
                  <input id="end-year" type="number" min="1900" [max]="getCurrentYear() + 10" placeholder="e.g. 2000"
                    [value]="endYear() || ''"
                    (input)="updateEndYear($any($event.target).value ? +$any($event.target).value : null)"
                    class="year-input">
                </div>
              </div>
              }

              <p class="year-filter-description">{{ yearFilterDescription() }}</p>
            </div>

            <div class="action-buttons">
              <button class="spotify-btn" (click)="createSpotifyPlaylistFromSelectedLabel()"
                [disabled]="isCreatingPlaylist()" title="Create Spotify playlist from label releases">
                @if (isCreatingPlaylist()) {
                <span class="spinner"></span>
                Creating...
                } @else {
                <span class="spotify-icon">â™ª</span>
                Create Playlist ({{ getEffectiveTrackCount() }} tracks/album)
                }
              </button>
              
              <button class="export-csv-btn" (click)="exportAllReleasesToCsv()"
                style="background: red !important; color: white !important; min-width: 200px !important;"
                title="Export all releases data to CSV">
                <span class="export-icon">ðŸ“„</span>
                Export CSV ({{ allReleases().length }})
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tree Visualization -->
      <div class="tree-visualization">
        @if (familyTree()?.tree) {
        <app-tree-node [node]="familyTree()!.tree" (nodeSelected)="selectNode($event)"></app-tree-node>
        }
      </div>
    </div>
    } @else if (selectedLabel()) {
    <div class="no-tree-message">
      <p>No family tree data available for {{ selectedLabel()?.name }}</p>
    </div>
    }
  </div>

</div>